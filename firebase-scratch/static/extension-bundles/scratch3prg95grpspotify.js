var scratch3prg95grpspotify=function(t,e,r){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,i.get?i:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var n=i(r);function o(t,e,r,i){return new(r||(r=Promise))((function(n,o){function a(t){try{u(i.next(t))}catch(t){o(t)}}function s(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((i=i.apply(t,e||[])).next())}))}const a=(t,e)=>{for(let r=0;r<t.length-e.length;r++){let i=!0;for(let n=0;n<e.length;n++){if(String.fromCharCode(t[r+n])!==e[n]){i=!1;break}}if(i)return r}return-1},s=(t,e,r)=>{let i,n=0;for(i=e;i<t.length&&(0==t[i]&&n++,!(n>=r));i++);i++;let o="";for(;i<t.length&&0!=t[i];){o+=String.fromCharCode(t[i]),i++}try{return Object.assign(Object.assign({},JSON.parse(o)),{buffer:t})}catch(t){return}};class u extends e.Extension{constructor(){super(...arguments),this.prevQuery="",this.currentArtistName="no artist",this.currentTrackName="no track",this.currentAlbumName="no album",this.player=(new n.Player).toDestination(),this.gain=new n.Gain,this.audioContext=n.context,this.beatPlayers=[],this.beatTimeouts=[],this.barTimeouts=[],this.currentBeatPlayerIndex=0,this.currentBeatNum=0,this.beatFlag=!1,this.barFlag=!1,this.songFlag=!1,this.currentTrackDuration=0,this.trackTempo=0,this.numBeats=0}init(t){return o(this,void 0,void 0,(function*(){const e={attack:.1,decay:0,sustain:1,release:.01};for(let t=0;t<4;t++){const t=new n.Player,r=new n.AmplitudeEnvelope(e).toDestination();t.connect(r),this.beatPlayers.push(t)}n.Destination.chain(this.gain),this.spotifyToken=yield l(),t.onStopSign(this.stopMusic)}))}playTrack(){const{player:t,trackTimingData:e,currentTrackDuration:r}=this;if(!t.buffer||!t.buffer.loaded||!e)return;const i=n.now();t.start(i,0,r),this.trackStartTime=i,this.songFlag=!0,this.setupTimeouts()}clearTimeouts(){clearTimeout(this.trackTimeout),this.beatTimeouts.forEach(clearTimeout),this.barTimeouts.forEach(clearTimeout)}resetTrackData(){this.player=(new n.Player).toDestination(),this.currentArtistName="no artist",this.currentTrackName="no track",this.currentAlbumName="no album",this.trackTempo=0}requestSearch(t){return o(this,void 0,void 0,(function*(){if(this.player.stop(),this.clearTimeouts(),""==t)return;this.currentBeatNum=0;if(t===this.prevQuery)return;const r=`https://api.spotify.com/v1/search?q=${t}&type=track`,i={Authorization:"Bearer "+this.spotifyToken.value},n=yield e.fetchWithTimeout(r,{headers:i,timeout:1e4});n.ok||console.log(`Error with Spotify API query: ${n}`);const{status:o}=n,a=yield n.json();if(!(200===o)){console.log(`Error with Spotify API query: ${a}`);if(!(401===o))return console.error(`Spotify token error: ${o}`);console.log("401 error");const t=yield l();return void(this.spotifyToken=t)}this.prevQuery=t;const s=a.tracks.items;if(!s||0===s.length)return this.resetTrackData();const u=s.filter((t=>!t.explicit));if(0===u.length)return this.resetTrackData(),console.log("no results without explicit lyrics");(yield e.asyncSome(u,this.tryGetTimingData.bind(this)))||(console.log("no more results"),this.resetTrackData())}))}tryGetTimingData({artists:t,name:e,album:r,preview_url:i}){return o(this,void 0,void 0,(function*(){return(yield this.tryGetTrackTimingData(i))?(this.currentArtistName=t[0].name,this.currentTrackName=e,this.currentAlbumName=r.name,!0):(console.log(`No timing data for ${e}.`),!1)}))}tryGetTrackTimingData(t){return o(this,void 0,void 0,(function*(){if(!t)return!1;const e=yield fetch(t);if(this.trackTimingData=yield(t=>o(void 0,void 0,void 0,(function*(){const e=yield t.arrayBuffer(),r=new Uint8Array(e),i=a(r,"GEOB");return s(r,i+1,8)})))(e),!this.trackTimingData)return!1;const{beats:r,loop_duration:i,buffer:n}=this.trackTimingData;let u=0;for(let t=0;t<r.length-1;t++)u+=r[t+1]-r[t];const c=60/(u/(r.length-1));this.trackTempo=c;const{index:l}=r.map(((t,e)=>({beat:t,index:e}))).find((()=>({beat:t})=>i<t));return this.numBeats=l,yield this.audioContext.rawContext.decodeAudioData(n.buffer,(t=>{const{player:e,beatPlayers:r}=this;e.buffer.set(t),this.currentTrackDuration=i,r.forEach((({buffer:e})=>e.set(t)))})),!0}))}setupTimeouts(){const{numBeats:t,trackTimingData:e}=this,{beats:r,downbeats:i}=e;this.beatTimeouts=[];for(let e=0;e<t;e++){const t=t=>{this.beatFlag=!0,this.currentBeatNum=t},i=1e3*(r[e]-.1),n=setTimeout(t.bind(this),i,e);this.beatTimeouts.push(n)}this.barTimeouts=[];for(let e=0;e<i.length;e++)if(i[e]<r[t-1]){const t=1e3*(i[e]-.1),r=setTimeout((()=>this.barFlag=!0),t);this.barTimeouts.push(r)}}stopMusic(){this.player.stop(),this.clearTimeouts(),this.songFlag=!1,this.resolvePlayUntil&&this.resolvePlayUntil()}defineBlocks(){return{searchAndPlay:m,searchAndPlayWait:y,stopMusic:f,musicStopped:g,everyBeat:d,everyBar:T,trackData:p}}}const c=()=>(new Date).getTime()/1e3,l=()=>o(void 0,void 0,void 0,(function*(){const t=yield e.fetchWithTimeout("https://u61j2fb017.execute-api.us-east-1.amazonaws.com/prod/get-spotify-token",{timeout:1e4});if(!t.ok)return void console.error(`Spotify token error: ${t}`);const{status:r}=t;if(!(200===r))return void console.error(`Spotify token error ${r}: ${t.statusText}`);const{token:i}=yield t.json();return{expirationTime:c()+3600,value:i}})),h=t=>new Promise(((e,r)=>{c()>t.expirationTime?l().then((r=>{t=r,console.log("token expired, got a new one"),e(t)})):e(t)})),m=t=>({type:e.BlockType.Command,arg:{type:e.ArgumentType.String,defaultValue:"tacos"},text:t=>`play music like ${t}`,operation:function(e){return o(this,void 0,void 0,(function*(){let r=yield h(t.spotifyToken);t.spotifyToken=r,yield t.requestSearch(e),yield t.playTrack(),setTimeout((()=>{t.songFlag=!1}),1e3*t.currentTrackDuration)}))}}),y=t=>({type:e.BlockType.Command,arg:{type:e.ArgumentType.String,defaultValue:"Lauryn Hill"},text:t=>`play music like ${t} until done`,operation:function(e){return o(this,void 0,void 0,(function*(){let r=yield h(t.spotifyToken);return t.spotifyToken=r,yield t.requestSearch(e),yield t.playTrack(),new Promise((e=>{t.resolvePlayUntil=e,setTimeout(t.resolvePlayUntil,1e3*t.currentTrackDuration)}))}))}}),f=t=>({type:e.BlockType.Command,text:"stop the music",operation:t.stopMusic}),p=()=>({type:e.BlockType.Reporter,arg:{type:e.ArgumentType.String,defaultValue:"full",options:["track","artist","album","full"]},text:t=>`${t} name`,operation:function(t){switch(t){case"track":return this.currentTrackName;case"artist":return this.currentArtistName;case"album":return this.currentAlbumName;case"full":return`${this.currentTrackName} by ${this.currentArtistName} from ${this.currentAlbumName}`;default:return""}}}),d=t=>({type:e.BlockType.Hat,text:"every beat",operation:function(){return console.log("Every beat"),t.beatFlag&&setTimeout((()=>t.beatFlag=!1),60),t.beatFlag}}),T=t=>({type:e.BlockType.Hat,text:"every 4 beats",operation:function(){return t.barFlag&&setTimeout((()=>t.barFlag=!1),60),t.barFlag}}),g=t=>({type:e.BlockType.Boolean,text:"music stopped?",operation:()=>!t.songFlag});return t.Extension=u,Object.defineProperty(t,"__esModule",{value:!0}),t}({},ExtensionFramework,Tone);//# sourceMappingURL=scratch3prg95grpspotify.js.map
