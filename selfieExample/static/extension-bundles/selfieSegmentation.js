var selfieSegmentation=function(e,t){"use strict";function a(e,t,a,s,n,i){function o(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var r,c=s.kind,l="getter"===c?"get":"setter"===c?"set":"value",d=!t&&e?s.static?e:e.prototype:null,h=t||(d?Object.getOwnPropertyDescriptor(d,s.name):{}),m=!1,g=a.length-1;g>=0;g--){var u={};for(var p in s)u[p]="access"===p?{}:s[p];for(var p in s.access)u.access[p]=s.access[p];u.addInitializer=function(e){if(m)throw new TypeError("Cannot add initializers after decoration has completed");i.push(o(e||null))};var f=(0,a[g])("accessor"===c?{get:h.get,set:h.set}:h[l],u);if("accessor"===c){if(void 0===f)continue;if(null===f||"object"!=typeof f)throw new TypeError("Object expected");(r=o(f.get))&&(h.get=r),(r=o(f.set))&&(h.set=r),(r=o(f.init))&&n.push(r)}else(r=o(f))&&("field"===c?n.push(r):h[l]=r)}d&&Object.defineProperty(d,s.name,h),m=!0}class s{makeImage(){return new Image}makeCanvas(){return document.createElement("canvas")}resize(e,t,a){const s=this.makeCanvas();s.width=t,s.height=e.height;let n=s.getContext("2d");n.imageSmoothingEnabled=!1,n.drawImage(e,0,0,s.width,s.height);const i=this.makeCanvas();return i.width=t,i.height=a,n=i.getContext("2d"),n.imageSmoothingEnabled=!1,n.drawImage(s,0,0,i.width,i.height),i}convertResolution1Bitmap(e,t){const a=new Image;a.src=e,a.onload=()=>{t(null,this.resize(a,2*a.width,2*a.height).toDataURL())},a.onerror=()=>{t("Image load failed")}}getResizedWidthHeight(e,t){const a=480,s=360;if(e<=a&&t<=s)return{width:2*e,height:2*t};if(e<=960&&t<=720)return{width:e,height:t};const n=e/t;return n>=1.3333333333333333?{width:960,height:960/n}:{width:720*n,height:720}}importBitmap(e){return new Promise(((t,a)=>{const s=this.makeImage();s.src=e,s.onload=()=>{const a=this.getResizedWidthHeight(s.width,s.height);if(a.width===s.width&&a.height===s.height)t(this.convertDataURIToBinary(e));else{const e=this.resize(s,a.width,a.height).toDataURL();t(this.convertDataURIToBinary(e))}},s.onerror=()=>{a("Image load failed :(")}}))}convertDataURIToBinary(e){const t=";base64,",a=e.indexOf(t)+t.length,s=e.substring(a),n=window.atob(s),i=n.length,o=new Uint8Array(new ArrayBuffer(i));for(let e=0;e<i;e++)o[e]=n.charCodeAt(e);return o}}let n;const i=async(e,t)=>{n??(n=new s);const a=t.storage,i=a.DataFormat.PNG,o=a.AssetType.ImageBitmap,r=await n.importBitmap(e),c=a.createAsset(o,i,r,null,!0);return{name:null,dataFormat:i,asset:c,md5:`${c.assetId}.${i}`,assetId:c.assetId}};let o=["Arabic","Chinese - Simplified","German","English","French","Hebrew","Japanese","Russian","Swedish"],r=["ara","chi_sim","deu","eng","fra","heb","jpn","rus","swe"];const c={name:"Selfie Detector",description:"Extension to create costumes for sprites from your very own webcam!",iconURL:"Gur_Projectdesign.jpg"};var l=(()=>{var e;let s,n,l,d,h,m,g,u,p,f,w,y,b,x=[];return e=class extends(t.extension(c,"video","drawable")){constructor(){super(...arguments,...["Selfie Detector","selfieSegmentation","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAH0AAAB8CAYAAABE3L+AAAAACXBIWXMAAAsTAAALEwEAmpwYAAADQElEQVR4nO3dMWsUQRyG8edyZyEqqBgVJHiaUvA76CcQK3sbsbJVv0AquxSKjaWlpBS0thDBwkpFLTQgQRQtTIxnsVdJsnO3c//du3nfH1x1Ozube8JuYLJ7vdFohGlZ6voArH2OLsjRBTm6IEcXNKh7893HD+vARWC7ncOxTAeB+6tnh4/qNqqNDlwFTs/skKwNL4Ha6KnT+6fZHYu1ZCu1ga/pghxdkKMLcnRBji7I0QU5uiBHF+ToghxdkKMLcnRBqVW2HLvAZuD+SzUATkVPEGUTGFLFt8mdB95GThAZ/S/wJ3D/pfoRPUHkNX0J6Afuv1RHoifwH3KCHF2QowtydEGOLsjRBTm6IEcX5OiCHF2QowuKjL6DV9iaeB89QeQq21HgJtVqm01uOXqC6Ojrgfu3hnxNF+ToghxdkKMLcnRBji7I0QU5uiBHF+ToghxdkKMLcvTyJJs6enmS98JFLq1uAdfxenqbBsCbSTaK8hN4Erh/ayjy9D7AtyrPJV/TBTm6IEcX5OiCHF2QowtydEGOLsjRBTm6IEcX5OiCIlfZcq0AJzua+zt5T2I+Bxyf0bFM6wvwuW6DeY5+B7jR0dzPgcsZ4+8BV2ZzKFNbA27XbTDPp/cun2KRO3eXjzxP/tPKPEff6XDu35njt2dyFM0kP7d5jm5BHF2QowtydEGOLsjRBTm6IEcX5OiCHF2Qowty9L0dyxx/eCZH0UzyG5nneWk110OqteUmv9g94G7N+yPgwPj1/6rWEtXtwq/H+2lTH3ia2qjk6LeAXw3HXgKeZcx9DXicMT5Uyaf31Yyxuaf3Q5njQ5Ucve1T68IoObrtw9EFObogRxfk6IIcXZCjC3J0QY4uyNEFlRw959ak3NuSurwlK8nR95Ybvct72ZJKXlrdoHoS9bQPJd4FTmTOvUa1tNv259sDHoxf+yo5+oUO5x6OX11I/twln95VfUtt4OiCHF2QowtydEGOLsjRBTm6IEcX5OiCHF2QowtKRV/J2PeZjLEAy5njVSWfPp1aZdugWrWZ9puRe8BXqlt6m3pB9QjtLh8MvGj6wKvURr3RKKeLLSJf0wU5uiBHF+ToghxdkKMLcnRB/wBIt0+4Irv7NwAAAABJRU5ErkJggg=="]),this.model=void function(e,t,a){for(var s=arguments.length>2,n=0;n<t.length;n++)a=s?t[n].call(e,a):t[n].call(e)}(this,x),this.drawables=[],this.mode="mask",this.echoLength=0,this.processFrequencyMs=100}async init(){this.enableVideo(),this.model=await(async e=>{const a=new(await t.untilExternalGlobalVariableLoaded("https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js","SelfieSegmentation"))({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1/${e}`});return a.setOptions({modelSelection:1}),a.onResults(e),await a.initialize(),a})((e=>this.processResults(e))),this.start(),this.getTesseractInfrence=await(async()=>{const e=document.createElement("img");e.hidden=!0;const a=await t.untilExternalGlobalVariableLoaded("https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js","Tesseract");return function(t,s){return e.src=s,a.recognize(e,t,{logger:e=>console.log(e)}).then((({data:{text:e}})=>e))}})()}processResults(e){const t=e.image,a=e.segmentationMask,{width:s,height:n}=a;this.imageHelper??(this.imageHelper=((e,t)=>{const a=document.body.appendChild(document.createElement("canvas"));a.hidden=!0,a.width=e,a.height=t;const s=a.getContext("2d");return{colorIn:(n,i)=>(s.save(),s.clearRect(0,0,e,t),s.drawImage(n,0,0),s.globalCompositeOperation="source-in",s.fillStyle=i,s.fillRect(0,0,a.width,a.height),s.restore(),s.getImageData(0,0,e,t)),getMasked:(n,i)=>(s.save(),s.clearRect(0,0,e,t),s.drawImage(i,0,0),s.globalCompositeOperation="source-in",s.fillStyle="white",s.fillRect(0,0,a.width,a.height),s.drawImage(n,0,0),s.restore(),s.getImageData(0,0,e,t)),getDataURL(n){s.save(),s.clearRect(0,0,e,t),s.putImageData(n,0,0);const i=a.toDataURL("image/png");return s.restore(),i}}})(s,n));const{drawables:i,mode:o,imageHelper:r,color:c}=this,l="color"===o?r.colorIn(a,c):r.getMasked(t,a);if(this.lastProcessedImage=l,this.echoLength<=0)0===i.length?i.push(this.createDrawable(l)):i[0].update(l);else{for(;i.length>this.echoLength;)i.shift().destroy();i.forEach(((e,t,{length:a})=>e.setTransparency((a-t)/a*100))),i.push(this.createDrawable(l))}}start(){this.processing||(this.processing=!0,this.loop())}stop(){this.processing=!1,this.clearDrawables()}async loop(){for(;this.processing;){const e=this.getVideoFrame("canvas"),a=Date.now();e&&await this.model.send({image:e});const s=Date.now()-a;await t.untilTimePassed(this.processFrequencyMs-s)}}clearDrawables(){this.drawables.forEach((e=>e.destroy())),this.drawables=[]}async setCostume(e){const t=this.imageHelper.getDataURL(this.lastProcessedImage),a=await i(t,this.runtime);a.name=`${this.id}_generated_${Date.now()}`;const s=e.target,{length:n}=s.getCostumes();await this.runtime.addCostume(a),s.addCostume(a,n),s.setCostume(n)}setVideoFeedTransparency(e){this.setVideoTransparency(e)}setDisplayMode(e){this.clearDrawables(),this.mode=e}setNumberOfEchos(e){this.echoLength=Math.min(100,Math.max(e,1))}setColor(e){this.color=t.rgbToHex(e)}setFrameRate(e){this.processFrequencyMs=1e3/e}setProcessingState(e){"on"===e?this.start():this.stop()}cameraSet(e){"on"==e?this.enableVideo():"off"==e&&this.disableVideo()}async xCostumesxSeconds(e,t,a){for(let t=0;t<=e;t++){const e=this.imageHelper.getDataURL(this.lastProcessedImage),t=await i(e,this.runtime);t.name=`${this.id}_generated_${Date.now()}`;const s=a.target,{length:n}=s.getCostumes();await this.runtime.addCostume(t),s.addCostume(t,n),s.setCostume(n)}}async generateText(){return await this.getTesseractInfrence("eng",this.imageHelper.getDataURL(this.getVideoFrame("image")))}async generateTextWLanguage(e){let t=o.indexOf(e),a=r[t];return await this.getTesseractInfrence(a,this.imageHelper.getDataURL(this.getVideoFrame("image")))}flipVideoBlock(e){this.flipVideo(!e)}TxtDetecUI(){}},v=e,"symbol"==typeof(k="default")&&(k=k.description?"[".concat(k.description,"]"):""),Object.defineProperty(v,"name",{configurable:!0,value:I?"".concat(I," ",k):k}),s=[t.block({type:"command",text:"Set selfie image as costume"})],n=[t.block({type:"command",text:e=>`Set video feed transparency to ${e}%`,arg:"number"})],l=[t.block({type:"command",text:e=>`Set mode to ${e}`,arg:{type:"string",options:["color","mask"],defaultValue:"mask"}})],d=[t.block({type:"command",text:e=>`Set echo count to ${e}`,arg:{type:"number",defaultValue:0,options:{items:[0,1,2,4,8,10,25,50,100],acceptsReporters:!0,handler:e=>{const t=parseInt(`${e}`);return isNaN(t)?1:t}}}})],h=[t.block({type:"command",text:e=>`Set fill color to ${e}`,arg:"color"})],m=[t.block((e=>({type:"command",text:e=>`Set processing rate to ${e} fps`,arg:{type:"number",options:[60,30,10,2,1],defaultValue:1e3/e.processFrequencyMs}})))],g=[t.block({type:"command",text:e=>`Turn processing ${e}`,arg:{type:"string",options:["on","off"]}})],u=[t.block({type:"command",text:e=>`Turn camera ${e}`,arg:{type:"string",options:["on","off"]}})],p=[t.block({type:"command",text:(e,t)=>`Make ${e} selfie images into costumes in ${t} seconds`,args:[{type:"number"},{type:"number"}]})],f=[t.block({type:"reporter",text:"Text recognized in image"})],w=[t.block({type:"reporter",arg:{type:"string",options:o},text:e=>`Text recognized in ${e}`})],y=[t.block({type:"command",text:e=>`Flip video ${e}`,arg:{type:"Boolean",options:[!0,!1]}})],b=[t.block({type:"button",text:"Take a picture: open UI"})],a(e,null,s,{kind:"method",name:"setCostume",static:!1,private:!1,access:{has:e=>"setCostume"in e,get:e=>e.setCostume}},null,x),a(e,null,n,{kind:"method",name:"setVideoFeedTransparency",static:!1,private:!1,access:{has:e=>"setVideoFeedTransparency"in e,get:e=>e.setVideoFeedTransparency}},null,x),a(e,null,l,{kind:"method",name:"setDisplayMode",static:!1,private:!1,access:{has:e=>"setDisplayMode"in e,get:e=>e.setDisplayMode}},null,x),a(e,null,d,{kind:"method",name:"setNumberOfEchos",static:!1,private:!1,access:{has:e=>"setNumberOfEchos"in e,get:e=>e.setNumberOfEchos}},null,x),a(e,null,h,{kind:"method",name:"setColor",static:!1,private:!1,access:{has:e=>"setColor"in e,get:e=>e.setColor}},null,x),a(e,null,m,{kind:"method",name:"setFrameRate",static:!1,private:!1,access:{has:e=>"setFrameRate"in e,get:e=>e.setFrameRate}},null,x),a(e,null,g,{kind:"method",name:"setProcessingState",static:!1,private:!1,access:{has:e=>"setProcessingState"in e,get:e=>e.setProcessingState}},null,x),a(e,null,u,{kind:"method",name:"cameraSet",static:!1,private:!1,access:{has:e=>"cameraSet"in e,get:e=>e.cameraSet}},null,x),a(e,null,p,{kind:"method",name:"xCostumesxSeconds",static:!1,private:!1,access:{has:e=>"xCostumesxSeconds"in e,get:e=>e.xCostumesxSeconds}},null,x),a(e,null,f,{kind:"method",name:"generateText",static:!1,private:!1,access:{has:e=>"generateText"in e,get:e=>e.generateText}},null,x),a(e,null,w,{kind:"method",name:"generateTextWLanguage",static:!1,private:!1,access:{has:e=>"generateTextWLanguage"in e,get:e=>e.generateTextWLanguage}},null,x),a(e,null,y,{kind:"method",name:"flipVideoBlock",static:!1,private:!1,access:{has:e=>"flipVideoBlock"in e,get:e=>e.flipVideoBlock}},null,x),a(e,null,b,{kind:"method",name:"TxtDetecUI",static:!1,private:!1,access:{has:e=>"TxtDetecUI"in e,get:e=>e.TxtDetecUI}},null,x),e;var v,k,I})();return e.Extension=l,Object.defineProperty(e,"__esModule",{value:!0}),e}({},ExtensionFramework);//# sourceMappingURL=selfieSegmentation.js.map
