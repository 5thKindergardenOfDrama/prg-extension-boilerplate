var doodlebot=function(e,t){"use strict";function r(e,t,r,n,i,s){function o(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,c=n.kind,u="getter"===c?"get":"setter"===c?"set":"value",l=!t&&e?n.static?e:e.prototype:null,d=t||(l?Object.getOwnPropertyDescriptor(l,n.name):{}),h=!1,m=r.length-1;m>=0;m--){var p={};for(var v in n)p[v]="access"===v?{}:n[v];for(var v in n.access)p.access[v]=n.access[v];p.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");s.push(o(e||null))};var f=(0,r[m])("accessor"===c?{get:d.get,set:d.set}:d[u],p);if("accessor"===c){if(void 0===f)continue;if(null===f||"object"!=typeof f)throw new TypeError("Object expected");(a=o(f.get))&&(d.get=a),(a=o(f.set))&&(d.set=a),(a=o(f.init))&&i.unshift(a)}else(a=o(f))&&("field"===c?i.unshift(a):d[u]=a)}l&&Object.defineProperty(l,n.name,d),h=!0}function n(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const i=Object.keys({angry:"a",annoyed:"y",confused:"m",disgust:"d",engaged:"e",fear:"f",happy:"h",love:"o",neutral:"n",sad:"s",sleeping:"l",surprise:"p",wink:"i",worried:"r",wrong:"w"}),s="e",o="x",a="m",c={battery:"f",bumper:"b",humidity:"h",pressure:"p",distance:"d",altimeter:"u",magnometer:"o",temperature:"t",accelerometer:"a",gyroscope:"g",light:"l"},u=Object.fromEntries(Object.entries(c).map((([e,t])=>[t,e])));function l(){}function d(){d.init.call(this)}function h(e){return void 0===e._maxListeners?d.defaultMaxListeners:e._maxListeners}function m(e,t,r,n){var i,s,o,a;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),o=s[t]):(s=e._events=new l,e._eventsCount=0),o){if("function"==typeof o?o=s[t]=n?[r,o]:[o,r]:n?o.unshift(r):o.push(r),!o.warned&&(i=h(e))&&i>0&&o.length>i){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,a=c,"function"==typeof console.warn?console.warn(a):console.log(a)}}else o=s[t]=r,++e._eventsCount;return e}function p(e,t,r){var n=!1;function i(){e.removeListener(t,i),n||(n=!0,r.apply(e,arguments))}return i.listener=r,i}function v(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function f(e,t){for(var r=new Array(t);t--;)r[t]=e[t];return r}l.prototype=Object.create(null),d.EventEmitter=d,d.usingDomains=!1,d.prototype.domain=void 0,d.prototype._events=void 0,d.prototype._maxListeners=void 0,d.defaultMaxListeners=10,d.init=function(){this.domain=null,d.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new l,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},d.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},d.prototype.getMaxListeners=function(){return h(this)},d.prototype.emit=function(e){var t,r,n,i,s,o,a,c="error"===e;if(o=this._events)c=c&&null==o.error;else if(!c)return!1;if(a=this.domain,c){if(t=arguments[1],!a){if(t instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(r=o[e]))return!1;var l="function"==typeof r;switch(n=arguments.length){case 1:!function(e,t,r){if(t)e.call(r);else for(var n=e.length,i=f(e,n),s=0;s<n;++s)i[s].call(r)}(r,l,this);break;case 2:!function(e,t,r,n){if(t)e.call(r,n);else for(var i=e.length,s=f(e,i),o=0;o<i;++o)s[o].call(r,n)}(r,l,this,arguments[1]);break;case 3:!function(e,t,r,n,i){if(t)e.call(r,n,i);else for(var s=e.length,o=f(e,s),a=0;a<s;++a)o[a].call(r,n,i)}(r,l,this,arguments[1],arguments[2]);break;case 4:!function(e,t,r,n,i,s){if(t)e.call(r,n,i,s);else for(var o=e.length,a=f(e,o),c=0;c<o;++c)a[c].call(r,n,i,s)}(r,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(n-1),s=1;s<n;s++)i[s-1]=arguments[s];!function(e,t,r,n){if(t)e.apply(r,n);else for(var i=e.length,s=f(e,i),o=0;o<i;++o)s[o].apply(r,n)}(r,l,this,i)}return!0},d.prototype.addListener=function(e,t){return m(this,e,t,!1)},d.prototype.on=d.prototype.addListener,d.prototype.prependListener=function(e,t){return m(this,e,t,!0)},d.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,p(this,e,t)),this},d.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,p(this,e,t)),this},d.prototype.removeListener=function(e,t){var r,n,i,s,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(n=this._events))return this;if(!(r=n[e]))return this;if(r===t||r.listener&&r.listener===t)0==--this._eventsCount?this._events=new l:(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,s=r.length;s-- >0;)if(r[s]===t||r[s].listener&&r[s].listener===t){o=r[s].listener,i=s;break}if(i<0)return this;if(1===r.length){if(r[0]=void 0,0==--this._eventsCount)return this._events=new l,this;delete n[e]}else!function(e,t){for(var r=t,n=r+1,i=e.length;n<i;r+=1,n+=1)e[r]=e[n];e.pop()}(r,i);n.removeListener&&this.emit("removeListener",e,o||t)}return this},d.prototype.off=function(e,t){return this.removeListener(e,t)},d.prototype.removeAllListeners=function(e){var t,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new l,this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=new l:delete r[e]),this;if(0===arguments.length){for(var n,i=Object.keys(r),s=0;s<i.length;++s)"removeListener"!==(n=i[s])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=new l,this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},d.prototype.listeners=function(e){var t,r=this._events;return r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(t):[]},d.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):v.call(e,t)},d.prototype.listenerCount=v,d.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};class y extends d{isEventListenerObject(e){return void 0!==e.handleEvent}addEventListener(e,t){if(t){const r=this.isEventListenerObject(t)?t.handleEvent:t;super.addListener(e,r)}}removeEventListener(e,t){if(t){const r=this.isEventListenerObject(t)?t.handleEvent:t;super.removeListener(e,r)}}dispatchEvent(e,t){const r="string"==typeof e?new CustomEvent(e,{detail:t}):e;return super.emit(r.type,r)}}class b{constructor(e=1){this.concurrent=e,this.queue=[],this.running=0}pump(){return n(this,void 0,void 0,(function*(){if(this.running>=this.concurrent)return;const e=this.queue.shift();if(e){this.running++;try{const t=yield e.fn();e.resolve(t)}catch(t){e.reject(t)}return this.running--,this.pump()}}))}add(e){return new Promise(((t,r)=>(this.queue.push({fn:e,resolve:t,reject:r}),this.pump())))}}class g{constructor(e,t){this.service=e,this.emitter=t,this.queue=new b}getCharacteristic(e){var t;return n(this,void 0,void 0,(function*(){return null!==(t=this.characteristics)&&void 0!==t||(this.characteristics=yield this.service.getCharacteristics()),this.characteristics.find((t=>t.uuid===e))}))}getCharacteristicValue(e){return n(this,void 0,void 0,(function*(){const t=yield this.getCharacteristic(e);if(!t)throw new Error("Unable to locate characteristic");return yield this.queue.add((()=>n(this,void 0,void 0,(function*(){return t.readValue()}))))}))}setCharacteristicValue(e,t){return n(this,void 0,void 0,(function*(){const r=yield this.getCharacteristic(e);if(!r)throw new Error("Unable to locate characteristic");yield this.queue.add((()=>n(this,void 0,void 0,(function*(){return r.writeValueWithoutResponse(t)}))))}))}handleListener(e,t,r){return n(this,void 0,void 0,(function*(){const i=yield this.getCharacteristic(t);i&&(yield this.queue.add((()=>n(this,void 0,void 0,(function*(){return i.startNotifications()})))),this.emitter.on("newListener",(t=>{if(!(t!==e||this.emitter.listenerCount(e)>0))return this.queue.add((()=>n(this,void 0,void 0,(function*(){return i.addEventListener("characteristicvaluechanged",r)}))))})),this.emitter.on("removeListener",(t=>{if(!(t!==e||this.emitter.listenerCount(e)>0))return this.queue.add((()=>n(this,void 0,void 0,(function*(){return i.removeEventListener("characteristicvaluechanged",r)}))))})))}))}}class w extends y{static create(e){return n(this,void 0,void 0,(function*(){const t=new w(e);return yield t.init(),t}))}constructor(e){super(),this.helper=new g(e,this)}init(){return n(this,void 0,void 0,(function*(){const{tx_uuid:e}=w;yield this.helper.handleListener("receive",e,this.receiveHandler.bind(this)),yield this.helper.handleListener("receiveText",e,this.receiveTextHandler.bind(this))}))}send(e){return n(this,void 0,void 0,(function*(){return this.helper.setCharacteristicValue(w.rx_uuid,e)}))}sendText(e){return n(this,void 0,void 0,(function*(){const t=e.split("").map((e=>e.charCodeAt(0)));return this.helper.setCharacteristicValue(w.rx_uuid,new Uint8Array(t).buffer)}))}receiveHandler(e){const t=e.target.value,r=new Uint8Array(t.buffer);this.dispatchEvent("receive",r)}receiveTextHandler(e){const t=e.target.value,r=new Uint8Array(t.buffer).slice(),n=String.fromCharCode.apply(null,r);this.dispatchEvent("receiveText",n)}}w.uuid="6e400001-b5a3-f393-e0a9-e50e24dcca9e",w.rx_uuid="6e400002-b5a3-f393-e0a9-e50e24dcca9e",w.tx_uuid="6e400003-b5a3-f393-e0a9-e50e24dcca9e";class E{static createService(e,t){return n(this,void 0,void 0,(function*(){const r=e.find((e=>e.uuid===t.uuid));if(r)return yield t.create(r)}))}static requestRobot(e,t){return n(this,void 0,void 0,(function*(){return yield e.requestDevice({filters:[{services:[w.uuid]}]})}))}static getServices(e){return n(this,void 0,void 0,(function*(){if(!e||!e.gatt)return null;e.gatt.connected||(yield e.gatt.connect());const t=yield e.gatt.getPrimaryServices();return{uartService:yield E.createService(t,w)}}))}static create(e,t){return n(this,void 0,void 0,(function*(){const r=yield E.requestRobot(e,t),n=yield E.getServices(r);if(!n)throw new Error("Unable to connect to doodlebot's UART service");return new E(r,n)}))}constructor(e,t){this.device=e,this.services=t,this.onMotor=new d,this.onSensor=new d,this.listeners=new Map,this.sensorData={bumper:{front:0,back:0},altimeter:0,battery:0,distance:0,humidity:0,temperature:0,pressure:0,gyroscope:{x:0,y:0,z:0},magnometer:{x:0,y:0,z:0},accelerometer:{x:0,y:0,z:0},light:{red:0,green:0,blue:0,alpha:0}},this.sensorState={bumper:!1,altimeter:!1,battery:!1,distance:!1,humidity:!1,temperature:!1,pressure:!1,gyroscope:!1,magnometer:!1,accelerometer:!1,light:!1};const{listeners:r}=this;r.set("receiveText",this.receiveText.bind(this));for(const[e,n]of r)t.uartService.addEventListener(e,n)}formCommand(...e){return`(${e.join(",")})`}parseCommand(e){return e.split("(").map((e=>e.replace(")",""))).map((e=>{const[t,...r]=e.split(",");return{command:t,parameters:r}}))}sendBLECommand(e,...t){const{uartService:r}=this.services;return r.sendText(this.formCommand(e,...t))}setSensor(e,t){this.onSensor.emit(e,t),this.sensorData[e]=t}receiveText(e){for(const{command:t,parameters:r}of this.parseCommand(e.detail))switch(t){case"ms":this.onMotor.emit("stop");break;case c.bumper:{const[e,n]=r.map((e=>Number.parseFloat(e)));this.setSensor(u[t],{front:e,back:n});break}case c.distance:case c.battery:case c.altimeter:case c.humidity:case c.temperature:case c.pressure:{const e=Number.parseFloat(r[0]);this.setSensor(u[t],e);break}case c.gyroscope:case c.magnometer:case c.accelerometer:{const[e,n,i]=r.map((e=>Number.parseFloat(e)));this.setSensor(u[t],{x:e,y:n,z:i});break}case c.light:{const[e,n,i,s]=r.map((e=>Number.parseFloat(e)));this.setSensor(u[t],{red:e,green:n,blue:i,alpha:s});break}default:throw new Error(`Not implemented: ${t}`)}}enableSensor(e){return n(this,void 0,void 0,(function*(){this.sensorState[e]||(yield this.sendBLECommand(s,c[e]),yield new Promise((t=>this.onSensor.once(e,t))),this.sensorState[e]=!0)}))}disableSensor(e){return n(this,void 0,void 0,(function*(){this.sensorState[e]&&(yield this.sendBLECommand(o,c[e]),this.sensorState[e]=!1)}))}getSensorReading(e){return n(this,void 0,void 0,(function*(){return yield this.enableSensor(e),this.sensorData[e]}))}motorCommand(e,...t){return n(this,void 0,void 0,(function*(){switch(e){case"steps":{this.pendingMotorCommand&&(yield this.pendingMotorCommand);const[e,r]=t;return yield this.sendBLECommand(a,e.steps,r.steps,e.stepsPerSecond,r.stepsPerSecond),this.pendingMotorCommand=new Promise((e=>this.onMotor.once("stop",e))),yield this.pendingMotorCommand,!0}case"arc":{this.pendingMotorCommand&&(yield this.pendingMotorCommand);const[e,r]=t;yield this.sendBLECommand(a,e,r),this.pendingMotorCommand=new Promise((e=>this.onMotor.once("stop",e))),yield this.pendingMotorCommand;break}case"stop":yield this.sendBLECommand(a,"s"),this.pendingMotorCommand=new Promise((e=>this.onMotor.once("stop",e))),yield this.pendingMotorCommand}}))}}const L={name:"Doodlebot",description:"Program a doodlebot robot",iconURL:"Replace with the name of your icon image file (which should be placed in the same directory as this file)",insetIconURL:"Replace with the name of your inset icon image file (which should be placed in the same directory as this file)"};let x=(()=>{var e;let s,o,a,c,u,l=t.extension(L,"indicators"),h=[];return e=class extends l{constructor(){super(...arguments),this.robot=void function(e,t,r){for(var n=arguments.length>2,i=0;i<t.length;i++)r=n?t[i].call(e,r):t[i].call(e)}(this,h),this.motorEvent=new d,this.dataEvent=new d}init(e){}onDeviceConnected(e,{uartService:t}){return n(this,void 0,void 0,(function*(){this.robot=e,this.uart=t,console.log("Connected to bluetooth device: ",e),this._robotStatus=2,yield this.indicateFor({position:"category",msg:"Connected to robot"},1e3),console.log("Listen for device disconnect"),this.robot.addEventListener("gattserverdisconnected",this.onDeviceDisconnected.bind(this)),this.uart.addEventListener("receiveText",this.updateSensors.bind(this)),yield this.sendCommandToRobot("(d,x,2,1,65535)",command_pause),this.playAnimation({ANIM:"neutral"})}))}onDeviceDisconnected(){return n(this,void 0,void 0,(function*(){console.log("Lost connection to robot"),this.stopBlink(),yield this.indicateFor({position:"category",msg:"Disconnecting from robot"},1e3),this._robotStatus=1,this.uart&&this.uart.removeEventListener&&this.uart.removeEventListener("receiveText",this.updateSensors.bind(this)),this._robotDevice.removeEventListener("gattserverdisconnected",this.onDeviceDisconnected.bind(this)),this._robotDevice=null,this._robotUart=null}))}connectToBLE(){return n(this,void 0,void 0,(function*(){console.log("Getting BLE device");const{bluetooth:e}=window.navigator;if(e)try{const t="Bluefruit52",r=yield E.requestRobot(e,t),n=yield E.getServices(r);n.uartService&&this.onDeviceConnected(r,n)}catch(e){console.error(e),"Bluetooth adapter not available."==e.message?alert("Your device does not support BLE connections."):"User cancelled the requestDevice() chooser."!==e.message&&alert("There was a problem connecting your device, please try again or request assistance.")}}))}updateSensors(e){const t=e.detail.split("(");console.log("Received message: ",t);for(let e=0;e<t.length;e++){let r=t[e];if(r)if("ms)"==r)console.log("Stop the motor"),this.motorEvent.emit("stop");else if(""!=r){let e=r.split(",");switch(e[0]){case"b":const t=Number.parseInt(e[1]),n=Number.parseInt(e[2]);this.dataEvent.emit("bumper.front",t),this.dataEvent.emit("bumper.back",n),this.sensorValues["bumper.front"]=t,this.sensorValues["bumper.back"]=n;break;case"l":this.dataEvent.emit("color.red",Number.parseFloat(e[1])),this.dataEvent.emit("color.green",Number.parseFloat(e[2])),this.dataEvent.emit("color.blue",Number.parseFloat(e[3])),this.sensorValues["color.red"]=Number.parseFloat(e[1]),this.sensorValues["color.green"]=Number.parseFloat(e[2]),this.sensorValues["color.blue"]=Number.parseFloat(e[3]);break;case"d":this.dataEvent.emit("distance",Number.parseInt(e[1])),this.sensorValues.distance=Number.parseInt(e[1]);break;case"h":this.dataEvent.emit("humidity",Number.parseFloat(e[1])),this.sensorValues.humidity=Number.parseFloat(e[1]);break;case"t":this.dataEvent.emit("temperature",Number.parseFloat(e[1])),this.sensorValues.temperature=Number.parseFloat(e[1]);break;case"p":this.dataEvent.emit("pressure",Number.parseFloat(e[1])),this.sensorValues.pressure=Number.parseFloat(e[1]);break;case"o":this.dataEvent.emit("magnetometer.roll",Number.parseFloat(e[1])),this.dataEvent.emit("magnetometer.pitch",Number.parseFloat(e[2])),this.dataEvent.emit("magnetometer.yaw",Number.parseFloat(e[3])),this.sensorValues["magnetometer.roll"]=Number.parseFloat(e[1]),this.sensorValues["magnetometer.pitch"]=Number.parseFloat(e[2]),this.sensorValues["magnetometer.yaw"]=Number.parseFloat(e[3]);break;case"g":this.dataEvent.emit("gyroscope.x",Number.parseFloat(e[1])),this.dataEvent.emit("gyroscope.y",Number.parseFloat(e[2])),this.dataEvent.emit("gyroscope.z",Number.parseFloat(e[3])),this.sensorValues["gyroscope.x"]=Number.parseFloat(e[1]),this.sensorValues["gyroscope.y"]=Number.parseFloat(e[2]),this.sensorValues["gyroscope.z"]=Number.parseFloat(e[3]);break;case"u":this.dataEvent.emit("altitude",Number.parseFloat(e[1])),this.sensorValues.altitude=Number.parseFloat(e[1]);break;case"x":this.dataEvent.emit("accelerometer.x",Number.parseFloat(e[1])),this.dataEvent.emit("accelerometer.y",Number.parseFloat(e[2])),this.dataEvent.emit("accelerometer.z",Number.parseFloat(e[3])),this.sensorValues["accelerometer.x"]=Number.parseFloat(e[1]),this.sensorValues["accelerometer.y"]=Number.parseFloat(e[2]),this.sensorValues["accelerometer.z"]=Number.parseFloat(e[3]);break;case"f":this.dataEvent.emit("battery",Number.parseFloat(e[1])),this.sensorValues.battery=Number.parseFloat(e[1]);break;case"c":this.dataEvent.emit("ipAddress",e[1].substring(7).replace(")",""));break;default:console.log("Received unrecognized data:",r)}}}}test(){}connect(){}playAnimation(e){}displayText(e){}clearDisplay(){}},(()=>{var n;const d="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(n=l[Symbol.metadata])&&void 0!==n?n:null):void 0;s=[t.buttonBlock("Test Robot")],o=[t.buttonBlock("Connect Robot")],a=[t.block({type:"command",text:e=>`play ${e} animation`,arg:{type:"string",options:i,defaultValue:"happy"}})],c=[t.block({type:"command",text:e=>`display text ${e}`,arg:{type:"string",defaultValue:"Hello!"}})],u=[t.block({type:"command",text:"clear display"})],r(e,null,s,{kind:"method",name:"test",static:!1,private:!1,access:{has:e=>"test"in e,get:e=>e.test},metadata:d},null,h),r(e,null,o,{kind:"method",name:"connect",static:!1,private:!1,access:{has:e=>"connect"in e,get:e=>e.connect},metadata:d},null,h),r(e,null,a,{kind:"method",name:"playAnimation",static:!1,private:!1,access:{has:e=>"playAnimation"in e,get:e=>e.playAnimation},metadata:d},null,h),r(e,null,c,{kind:"method",name:"displayText",static:!1,private:!1,access:{has:e=>"displayText"in e,get:e=>e.displayText},metadata:d},null,h),r(e,null,u,{kind:"method",name:"clearDisplay",static:!1,private:!1,access:{has:e=>"clearDisplay"in e,get:e=>e.clearDisplay},metadata:d},null,h),d&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:d})})(),e})();return e.Extension=x,Object.defineProperty(e,"__esModule",{value:!0}),e}({},ExtensionFramework);//# sourceMappingURL=doodlebot.js.map
