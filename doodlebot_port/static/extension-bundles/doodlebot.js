var doodlebot=function(e,t){"use strict";function n(){}function o(e){return e()}function i(){return Object.create(null)}function r(e){e.forEach(o)}function s(e){return"function"==typeof e}function c(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function a(e,t){e.appendChild(t)}function d(e,t,n){const o=function(e){if(!e)return document;const t=e.getRootNode?e.getRootNode():e.ownerDocument;if(t&&t.host)return t;return e.ownerDocument}(e);if(!o.getElementById(t)){const e=h("style");e.id=t,e.textContent=n,function(e,t){a(e.head||e,t),t.sheet}(o,e)}}function l(e,t,n){e.insertBefore(t,n||null)}function u(e){e.parentNode&&e.parentNode.removeChild(e)}function h(e){return document.createElement(e)}function f(e){return document.createTextNode(e)}function v(){return f(" ")}function p(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function m(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function g(e,t){t=""+t,e.data!==t&&(e.data=t)}function y(e,t){e.value=null==t?"":t}function b(e,t,n,o){null==n?e.style.removeProperty(t):e.style.setProperty(t,n,o?"important":"")}let w;function k(e){w=e}function x(e){(function(){if(!w)throw new Error("Function called outside component initialization");return w})().$$.on_destroy.push(e)}const E=[],S=[];let L=[];const C=[],$=Promise.resolve();let P=!1;function _(e){L.push(e)}const B=new Set;let I=0;function T(){if(0!==I)return;const e=w;do{try{for(;I<E.length;){const e=E[I];I++,k(e),A(e.$$)}}catch(e){throw E.length=0,I=0,e}for(k(null),E.length=0,I=0;S.length;)S.pop()();for(let e=0;e<L.length;e+=1){const t=L[e];B.has(t)||(B.add(t),t())}L.length=0}while(E.length);for(;C.length;)C.pop()();P=!1,B.clear(),k(e)}function A(e){if(null!==e.fragment){e.update(),r(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(_)}}const D=new Set;function O(e){return void 0!==e?.length?e:Array.from(e)}function V(e,t){const n=e.$$;null!==n.fragment&&(!function(e){const t=[],n=[];L.forEach((o=>-1===e.indexOf(o)?t.push(o):n.push(o))),n.forEach((e=>e())),L=t}(n.after_update),r(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function N(e,t){-1===e.$$.dirty[0]&&(E.push(e),P||(P=!0,$.then(T)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function R(e,t,c,a,d,l,h=null,f=[-1]){const v=w;k(e);const p=e.$$={fragment:null,ctx:[],props:l,update:n,not_equal:d,bound:i(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(v?v.$$.context:[])),callbacks:i(),dirty:f,skip_bound:!1,root:t.target||v.$$.root};h&&h(p.root);let m=!1;if(p.ctx=c?c(e,t.props||{},((t,n,...o)=>{const i=o.length?o[0]:n;return p.ctx&&d(p.ctx[t],p.ctx[t]=i)&&(!p.skip_bound&&p.bound[t]&&p.bound[t](i),m&&N(e,t)),n})):[],p.update(),m=!0,r(p.before_update),p.fragment=!!a&&a(p.ctx),t.target){if(t.hydrate){const e=function(e){return Array.from(e.childNodes)}(t.target);p.fragment&&p.fragment.l(e),e.forEach(u)}else p.fragment&&p.fragment.c();t.intro&&((g=e.$$.fragment)&&g.i&&(D.delete(g),g.i(y))),function(e,t,n){const{fragment:i,after_update:c}=e.$$;i&&i.m(t,n),_((()=>{const t=e.$$.on_mount.map(o).filter(s);e.$$.on_destroy?e.$$.on_destroy.push(...t):r(t),e.$$.on_mount=[]})),c.forEach(_)}(e,t.target,t.anchor),T()}var g,y;k(v)}class j{$$=void 0;$$set=void 0;$destroy(){V(this,1),this.$destroy=n}$on(e,t){if(!s(t))return n;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(t),()=>{const e=o.indexOf(t);-1!==e&&o.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function q(e){d(e,"svelte-1xi6yus",".container.svelte-1xi6yus{text-align:center;padding:30px}button.svelte-1xi6yus{font-size:2rem}")}function M(e){let o,i,r,s,c,d,f,g;return{c(){o=h("div"),i=h("h1"),i.textContent="Doodlebot's bluetooth connection was reset.",r=v(),s=h("h2"),s.textContent="Please click the button below to open up the bluetooth and reselect your\n    device.",c=v(),d=h("button"),d.textContent="Open Bluetooth Menu",m(d,"class","svelte-1xi6yus"),m(o,"class","svelte-1xi6yus"),function(e,t,n){e.classList.toggle(t,!!n)}(o,"container",e[0]),b(o,"width","90vw"),b(o,"background-color",t.color.ui.white),b(o,"color",t.color.text.primary)},m(t,n){l(t,o,n),a(o,i),a(o,r),a(o,s),a(o,c),a(o,d),f||(g=p(d,"click",e[1]),f=!0)},p:n,i:n,o:n,d(e){e&&u(o),f=!1,g()}}}function W(e,n,o){let{extension:i}=n,{close:r}=n;const s=t.activeClass;return x((()=>{console.log("Closed")})),e.$$set=e=>{"extension"in e&&o(2,i=e.extension),"close"in e&&o(3,r=e.close)},[s,()=>{i.bluetoothEmitter.emit("bluetooth",window.navigator.bluetooth),r()},i,r]}"undefined"!=typeof window&&(window.__svelte||(window.__svelte={v:new Set})).v.add("4");function U(e,t,n,o,i,r){function s(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var c,a=o.kind,d="getter"===a?"get":"setter"===a?"set":"value",l=!t&&e?o.static?e:e.prototype:null,u=t||(l?Object.getOwnPropertyDescriptor(l,o.name):{}),h=!1,f=n.length-1;f>=0;f--){var v={};for(var p in o)v[p]="access"===p?{}:o[p];for(var p in o.access)v.access[p]=o.access[p];v.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");r.push(s(e||null))};var m=(0,n[f])("accessor"===a?{get:u.get,set:u.set}:u[d],v);if("accessor"===a){if(void 0===m)continue;if(null===m||"object"!=typeof m)throw new TypeError("Object expected");(c=s(m.get))&&(u.get=c),(c=s(m.set))&&(u.set=c),(c=s(m.init))&&i.unshift(c)}else(c=s(m))&&("field"===a?i.unshift(c):u[d]=c)}l&&Object.defineProperty(l,o.name,u),h=!0}function F(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))}function z(){}function H(){H.init.call(this)}function Y(e){return void 0===e._maxListeners?H.defaultMaxListeners:e._maxListeners}function G(e,t,n,o){var i,r,s,c;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((r=e._events)?(r.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),r=e._events),s=r[t]):(r=e._events=new z,e._eventsCount=0),s){if("function"==typeof s?s=r[t]=o?[n,s]:[s,n]:o?s.unshift(n):s.push(n),!s.warned&&(i=Y(e))&&i>0&&s.length>i){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=s.length,c=a,"function"==typeof console.warn?console.warn(c):console.log(c)}}else s=r[t]=n,++e._eventsCount;return e}function J(e,t,n){var o=!1;function i(){e.removeListener(t,i),o||(o=!0,n.apply(e,arguments))}return i.listener=n,i}function K(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function Q(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}"function"==typeof SuppressedError&&SuppressedError,z.prototype=Object.create(null),H.EventEmitter=H,H.usingDomains=!1,H.prototype.domain=void 0,H.prototype._events=void 0,H.prototype._maxListeners=void 0,H.defaultMaxListeners=10,H.init=function(){this.domain=null,H.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new z,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},H.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},H.prototype.getMaxListeners=function(){return Y(this)},H.prototype.emit=function(e){var t,n,o,i,r,s,c,a="error"===e;if(s=this._events)a=a&&null==s.error;else if(!a)return!1;if(c=this.domain,a){if(t=arguments[1],!c){if(t instanceof Error)throw t;var d=new Error('Uncaught, unspecified "error" event. ('+t+")");throw d.context=t,d}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=c,t.domainThrown=!1,c.emit("error",t),!1}if(!(n=s[e]))return!1;var l="function"==typeof n;switch(o=arguments.length){case 1:!function(e,t,n){if(t)e.call(n);else for(var o=e.length,i=Q(e,o),r=0;r<o;++r)i[r].call(n)}(n,l,this);break;case 2:!function(e,t,n,o){if(t)e.call(n,o);else for(var i=e.length,r=Q(e,i),s=0;s<i;++s)r[s].call(n,o)}(n,l,this,arguments[1]);break;case 3:!function(e,t,n,o,i){if(t)e.call(n,o,i);else for(var r=e.length,s=Q(e,r),c=0;c<r;++c)s[c].call(n,o,i)}(n,l,this,arguments[1],arguments[2]);break;case 4:!function(e,t,n,o,i,r){if(t)e.call(n,o,i,r);else for(var s=e.length,c=Q(e,s),a=0;a<s;++a)c[a].call(n,o,i,r)}(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(o-1),r=1;r<o;r++)i[r-1]=arguments[r];!function(e,t,n,o){if(t)e.apply(n,o);else for(var i=e.length,r=Q(e,i),s=0;s<i;++s)r[s].apply(n,o)}(n,l,this,i)}return!0},H.prototype.addListener=function(e,t){return G(this,e,t,!1)},H.prototype.on=H.prototype.addListener,H.prototype.prependListener=function(e,t){return G(this,e,t,!0)},H.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,J(this,e,t)),this},H.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,J(this,e,t)),this},H.prototype.removeListener=function(e,t){var n,o,i,r,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(o=this._events))return this;if(!(n=o[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new z:(delete o[e],o.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,r=n.length;r-- >0;)if(n[r]===t||n[r].listener&&n[r].listener===t){s=n[r].listener,i=r;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new z,this;delete o[e]}else!function(e,t){for(var n=t,o=n+1,i=e.length;o<i;n+=1,o+=1)e[n]=e[o];e.pop()}(n,i);o.removeListener&&this.emit("removeListener",e,s||t)}return this},H.prototype.off=function(e,t){return this.removeListener(e,t)},H.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new z,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new z:delete n[e]),this;if(0===arguments.length){for(var o,i=Object.keys(n),r=0;r<i.length;++r)"removeListener"!==(o=i[r])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=new z,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},H.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},H.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):K.call(e,t)},H.prototype.listenerCount=K,H.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};class X extends H{isEventListenerObject(e){return void 0!==e.handleEvent}addEventListener(e,t){if(t){const n=this.isEventListenerObject(t)?t.handleEvent:t;super.addListener(e,n)}}removeEventListener(e,t){if(t){const n=this.isEventListenerObject(t)?t.handleEvent:t;super.removeListener(e,n)}}dispatchEvent(e,t){const n="string"==typeof e?new CustomEvent(e,{detail:t}):e;return super.emit(n.type,n)}}class Z{constructor(e=1){this.concurrent=e,this.queue=[],this.running=0}pump(){return F(this,void 0,void 0,(function*(){if(this.running>=this.concurrent)return;const e=this.queue.shift();if(e){this.running++;try{const t=yield e.fn();e.resolve(t)}catch(t){e.reject(t)}return this.running--,this.pump()}}))}add(e){return new Promise(((t,n)=>(this.queue.push({fn:e,resolve:t,reject:n}),this.pump())))}}class ee{constructor(e,t){this.service=e,this.emitter=t,this.queue=new Z}getCharacteristic(e){var t;return F(this,void 0,void 0,(function*(){return null!==(t=this.characteristics)&&void 0!==t||(this.characteristics=yield this.service.getCharacteristics()),this.characteristics.find((t=>t.uuid===e))}))}getCharacteristicValue(e){return F(this,void 0,void 0,(function*(){const t=yield this.getCharacteristic(e);if(!t)throw new Error("Unable to locate characteristic");return yield this.queue.add((()=>F(this,void 0,void 0,(function*(){return t.readValue()}))))}))}setCharacteristicValue(e,t){return F(this,void 0,void 0,(function*(){const n=yield this.getCharacteristic(e);if(!n)throw new Error("Unable to locate characteristic");yield this.queue.add((()=>F(this,void 0,void 0,(function*(){return n.writeValueWithoutResponse(t)}))))}))}handleListener(e,t,n){return F(this,void 0,void 0,(function*(){const o=yield this.getCharacteristic(t);o&&(yield this.queue.add((()=>F(this,void 0,void 0,(function*(){return o.startNotifications()})))),this.emitter.on("newListener",(t=>{if(!(t!==e||this.emitter.listenerCount(e)>0))return this.queue.add((()=>F(this,void 0,void 0,(function*(){return o.addEventListener("characteristicvaluechanged",n)}))))})),this.emitter.on("removeListener",(t=>{if(!(t!==e||this.emitter.listenerCount(e)>0))return this.queue.add((()=>F(this,void 0,void 0,(function*(){return o.removeEventListener("characteristicvaluechanged",n)}))))})))}))}}class te extends X{static create(e){return F(this,void 0,void 0,(function*(){const t=new te(e);return yield t.init(),t}))}constructor(e){super(),this.helper=new ee(e,this)}init(){return F(this,void 0,void 0,(function*(){const{tx_uuid:e}=te;yield this.helper.handleListener("receive",e,this.receiveHandler.bind(this)),yield this.helper.handleListener("receiveText",e,this.receiveTextHandler.bind(this))}))}send(e){return F(this,void 0,void 0,(function*(){return this.helper.setCharacteristicValue(te.rx_uuid,e)}))}sendText(e){return F(this,void 0,void 0,(function*(){console.log("sending text",e);const t=e.split("").map((e=>e.charCodeAt(0)));return this.helper.setCharacteristicValue(te.rx_uuid,new Uint8Array(t).buffer)}))}receiveHandler(e){const t=e.target.value,n=new Uint8Array(t.buffer);this.dispatchEvent("receive",n)}receiveTextHandler(e){const t=e.target.value,n=new Uint8Array(t.buffer).slice(),o=String.fromCharCode.apply(null,n);console.log("received text",o),this.dispatchEvent("receiveText",o)}}te.uuid="6e400001-b5a3-f393-e0a9-e50e24dcca9e",te.rx_uuid="6e400002-b5a3-f393-e0a9-e50e24dcca9e",te.tx_uuid="6e400003-b5a3-f393-e0a9-e50e24dcca9e";const ne={enable:"e",disable:"x",motor:"m",arc:"t",wifi:"k",lowPower:"q",display:"d",pen:"u",network:"g"},oe={battery:"f",bumper:"b",humidity:"h",pressure:"p",distance:"d",altimeter:"u",magnometer:"o",temperature:"t",accelerometer:"a",gyroscope:"g",light:"l"},ie=Object.keys(oe),re={clear:"c",sad:"s",happy:"T",child:"H"},se=Object.keys(re),ce=Object.fromEntries(Object.entries(oe).map((([e,t])=>[t,e]))),ae="RPI ipaddr:",de="hname:",le="8765",ue="8000",he="8771",fe="video_feed",ve=e=>{if(!e)return[];return e.split(/,\s*|\s+/)},pe=(e,t)=>e.replace(t,"").trim(),me="127.0.0.1",ge="motor",ye="connect",be="disconnect",we=(e,t)=>{switch(t){case"success":console.log(e);break;case"warning":console.warn(e);break;case"error":console.error(e)}};class ke{static tryCreateService(e,t){return F(this,void 0,void 0,(function*(){const n=e.find((e=>e.uuid===t.uuid));return n?yield t.create(n):void 0}))}static requestRobot(e,...t){return F(this,void 0,void 0,(function*(){return yield e.requestDevice({filters:[...null!=t?t:[],{services:[te.uuid]}]})}))}static getServices(e){return F(this,void 0,void 0,(function*(){if(!e||!e.gatt)return null;e.gatt.connected||(yield e.gatt.connect());const t=yield e.gatt.getPrimaryServices();return{uartService:yield ke.tryCreateService(t,te)}}))}static getBLE(e,...t){return F(this,void 0,void 0,(function*(){const n=yield ke.requestRobot(e,...t),o=yield ke.getServices(n);if(!o)throw new Error("Unable to connect to doodlebot's UART service");return{robot:n,services:o}}))}static tryCreate(e,{requestBluetooth:t,credentials:n,saveIP:o},...i){return F(this,void 0,void 0,(function*(){const{robot:r,services:s}=yield ke.getBLE(e,...i);return new ke(r,s,t,n,o)}))}constructor(e,t,n,o,i){this.device=e,this.services=t,this.requestBluetooth=n,this.credentials=o,this.saveIP=i,this.pending={motor:void 0,wifi:void 0,websocket:void 0,ip:void 0},this.onMotor=new H,this.onSensor=new H,this.onNetwork=new H,this.disconnectCallbacks=new Set,this.subscriptions=new Array,this.encoder=new TextEncoder,this.isStopped=!0,this.sensorData={bumper:{front:0,back:0},altimeter:0,battery:0,distance:0,humidity:0,temperature:0,pressure:0,gyroscope:{x:0,y:0,z:0},magnometer:{x:0,y:0,z:0},accelerometer:{x:0,y:0,z:0},light:{red:0,green:0,blue:0,alpha:0}},this.sensorState={bumper:!1,altimeter:!1,battery:!1,distance:!1,humidity:!1,temperature:!1,pressure:!1,gyroscope:!1,magnometer:!1,accelerometer:!1,light:!1},this.attachToBLE(e,t),this.connectionWorkflow(o)}attachToBLE(e,t){this.device=e,this.services=t,this.subscribe(t.uartService,"receiveText",this.receiveTextBLE.bind(this)),this.subscribe(e,"gattserverdisconnected",this.handleBleDisconnect.bind(this))}subscribe(e,t,n){e.addEventListener(t,n),this.subscriptions.push({target:e,event:t,listener:n})}formCommand(...e){return`(${e.join(",")})`}parseCommand(e){return e.split("(").map((e=>e.replace(")",""))).splice(1).map((e=>{const[t,...n]=e.split(",").map((e=>e.trim()));return{command:t,parameters:n}}))}updateSensor(e,t){this.onSensor.emit(e,t),this.sensorData[e]=t,this.sensorState[e]=!0}updateNetworkStatus(e,t){const n=pe(e,ae),o=pe(t,de);if(n===me)return this.onNetwork.emit(be);this.connection={ip:n,hostname:o},this.onNetwork.emit(ye,this.connection)}receiveTextBLE(e){const{detail:t}=e;if(console.log("received text",t),t.startsWith(ae)){const e=t.split(",");this.updateNetworkStatus(e[0],e[1])}else for(const{command:e,parameters:n}of this.parseCommand(t))switch(console.log({command:e,parameters:n}),e){case"ms":this.isStopped=!0,this.onMotor.emit(ge);break;case oe.bumper:{const[t,o]=n.map((e=>Number.parseFloat(e)));this.updateSensor(ce[e],{front:t,back:o});break}case oe.distance:case oe.battery:case oe.altimeter:case oe.humidity:case oe.temperature:case oe.pressure:{const t=Number.parseFloat(n[0]);this.updateSensor(ce[e],t);break}case oe.gyroscope:case oe.magnometer:case oe.accelerometer:{const[t,o,i]=n.map((e=>Number.parseFloat(e)));this.updateSensor(ce[e],{x:t,y:o,z:i});break}case oe.light:{const[t,o,i,r]=n.map((e=>Number.parseFloat(e)));this.updateSensor(ce[e],{red:t,green:o,blue:i,alpha:r});break}default:throw new Error(`Not implemented: ${e}`)}}onWebsocketMessage(e){return F(this,void 0,void 0,(function*(){console.log("websocket message",{event:e});const t=yield e.data.text();console.log(t)}))}invalidateWifiConnection(){var e;this.connection=void 0,this.pending.wifi=void 0,this.pending.websocket=void 0,null===(e=this.websocket)||void 0===e||e.close(),this.websocket=void 0}handleBleDisconnect(){console.log("disconnected!!!");for(const e of this.disconnectCallbacks)e();for(const{target:e,event:t,listener:n}of this.subscriptions)e.removeEventListener(t,n)}onDisconnect(...e){for(const t of e)this.disconnectCallbacks.add(t)}enableSensor(e){return F(this,void 0,void 0,(function*(){this.sensorState[e]||(yield this.sendBLECommand(ne.enable,oe[e]),yield new Promise((t=>this.onSensor.once(e,t))),this.sensorState[e]=!0)}))}disableSensor(e){return F(this,void 0,void 0,(function*(){this.sensorState[e]&&(yield this.sendBLECommand(ne.disable,oe[e]),this.sensorState[e]=!1)}))}getSensorReading(e){return F(this,void 0,void 0,(function*(){return yield this.enableSensor(e),this.sensorData[e]}))}getSensorReadingImmediately(e){return this.enableSensor(e),this.sensorData[e]}motorCommand(e,...t){return F(this,void 0,void 0,(function*(){const{pending:{motor:n}}=this;switch(e){case"steps":{n&&(yield n);const[e,o]=t;return yield this.untilFinishedPending("motor",new Promise((t=>F(this,void 0,void 0,(function*(){this.isStopped=!1,yield this.sendBLECommand(ne.motor,e.steps,o.steps,e.stepsPerSecond,o.stepsPerSecond),this.onMotor.once(ge,t)})))))}case"arc":{n&&(yield n);const[e,o]=t;return yield this.untilFinishedPending("motor",new Promise((t=>F(this,void 0,void 0,(function*(){this.isStopped=!1,yield this.sendBLECommand(ne.arc,e,o),this.onMotor.once(ge,t)})))))}case"stop":if(this.isStopped)return;return yield this.untilFinishedPending("motor",new Promise((e=>F(this,void 0,void 0,(function*(){yield this.sendBLECommand(ne.motor,"s"),this.onMotor.once(ge,e)})))))}}))}penCommand(e){return F(this,void 0,void 0,(function*(){yield this.sendBLECommand(ne.pen,"up"===e?0:45)}))}lowPowerMode(){return F(this,void 0,void 0,(function*(){yield this.sendBLECommand(ne.lowPower)}))}getIPAddress(){return F(this,void 0,void 0,(function*(){const e=this,t=setTimeout((()=>this.sendBLECommand(ne.network)),1e3),n=yield new Promise((t=>F(this,void 0,void 0,(function*(){this.onNetwork.once(ye,(()=>t(e.connection.ip))),this.onNetwork.once(be,(()=>t(null)))}))));return console.log(`Got ip: ${n}`),clearTimeout(t),n}))}testIP(e){return F(this,void 0,void 0,(function*(){if(!e)return!1;const t=new AbortController,n=setTimeout((()=>t.abort()),2e3);try{return(yield fetch(`http://${e}:${ue}/${fe}`,{signal:t.signal})).ok}catch(e){return!1}finally{clearTimeout(n)}}))}setIP(e){var t;return null!==(t=this.connection)&&void 0!==t||(this.connection={ip:e}),this.saveIP(e),this.connection.ip=e}connectToWifi(e){return F(this,void 0,void 0,(function*(){if(e.ipOverride){we("Testing stored IP address","warning");const t=yield this.testIP(e.ipOverride);if(we(t?"Validated stored IP address":"Stored IP address could not be reached",t?"success":"warning"),t)return this.setIP(e.ipOverride)}return we("Asking doodlebot for it's IP","warning"),we("Could not retrieve IP address from doodlebot","error"),new Promise((t=>F(this,void 0,void 0,(function*(){const n=this,{device:o}=this;let i;const r=()=>F(this,void 0,void 0,(function*(){this.requestBluetooth((e=>F(this,void 0,void 0,(function*(){we("Reconnected to doodlebot","success"),clearInterval(i);const{robot:s,services:c}=yield ke.getBLE(e);n.attachToBLE(s,c),o.removeEventListener("gattserverdisconnected",r),we("Testing doodlebot's IP after reconnect","warning");const a=yield n.getIPAddress();we(a===me?"Doodlebot's IP is local, not valid":"Doodlebot's IP is valid",a===me?"warning":"success"),t(this.setIP(a))}))))}));o.addEventListener("gattserverdisconnected",r),we("Attempting to connect to wifi","warning"),yield this.sendBLECommand(ne.wifi,e.ssid,e.password),i=setInterval((()=>this.sendBLECommand(ne.network)),5e3)}))))}))}connectToWebsocket(e){return F(this,void 0,void 0,(function*(){this.websocket=((e,t)=>new WebSocket(`ws://${e}:${t}`))(e,le),yield this.untilFinishedPending("websocket",new Promise((e=>{const t=()=>{console.log("Connected to websocket"),this.websocket.removeEventListener("open",t),e()};this.websocket.addEventListener("open",t),this.websocket.addEventListener("message",this.onWebsocketMessage.bind(this))})))}))}connectionWorkflow(e){return F(this,void 0,void 0,(function*(){yield this.connectToWifi(e),yield this.connectToWebsocket(this.connection.ip)}))}getImageStream(){return F(this,void 0,void 0,(function*(){if(!this.connection.ip)return;const e=document.createElement("img");return e.src=`http://${this.connection.ip}:${ue}/${fe}`,e.crossOrigin="anonymous",yield new Promise((t=>e.addEventListener("load",t))),e}))}getAudioStream(e,t=1){return F(this,void 0,void 0,(function*(){const n=new WebSocket(`ws://${e}:${he}`),o=new(window.AudioContext||window.webkitAudioContext),i=o.createBuffer(1,48e3*t,48e3);let r=0;n.onmessage=function(e){return F(this,void 0,void 0,(function*(){const t=r++,n=JSON.parse(e.data),o=yield(s=n.audio_data,F(void 0,void 0,void 0,(function*(){const e=yield fetch(`data:application/octet-stream;base64,${s}`),t=yield e.blob(),n=yield t.arrayBuffer();return new Float32Array(n)})));var s;console.log(o.length),i.copyToChannel(o,0,t*o.length)}))},n.onerror=function(e){console.error("WebSocket Error:",e)};const s=this.encoder.encode("(1)");return n.onopen=function(e){console.log("WebSocket connection established"),n.send(s)},n.onclose=function(){console.log("WebSocket connection closed");const e=o.createBufferSource();e.buffer=i,e.connect(o.destination),e.start()},n}))}display(e){return F(this,void 0,void 0,(function*(){const t=re[e];yield this.sendWebsocketCommand(ne.display,t)}))}sendBLECommand(e,...t){const{uartService:n}=this.services;return n.sendText(this.formCommand(e,...t))}sendWebsocketCommand(e,...t){const n=this.formCommand(e,...t);console.log("sending websocket message",n),this.websocket.send(this.encoder.encode(n))}untilFinishedPending(e,t){return F(this,void 0,void 0,(function*(){this.pending[e]=t;const n=yield t;return this.pending[e]=void 0,n}))}}function xe(e){d(e,"svelte-7iy7lk",".container.svelte-7iy7lk{text-align:center;padding:30px}.error.svelte-7iy7lk{background-color:red;color:white;padding:4px 8px;text-align:center;border-radius:5px}.collapser.svelte-7iy7lk{background-color:inherit;cursor:pointer;border:none;text-align:left;outline:none}.ip.svelte-7iy7lk{width:3rem}")}function Ee(e,t,n){const o=e.slice();return o[27]=t[n],o[28]=t,o[29]=n,o}function Se(e){let t,n;return{c(){t=h("div"),n=f(e[0]),m(t,"class","error svelte-7iy7lk")},m(e,o){l(e,t,o),a(t,n)},p(e,t){1&t&&g(n,e[0])},d(e){e&&u(t)}}}function Le(e){let t;return{c(){t=f("Uh oh! Your browser does not support bluetooth. Here's how to fix that...\n    TBD")},m(e,n){l(e,t,n)},p:n,d(e){e&&u(t)}}}function Ce(e){let t,n,o,i,s,c,d,w,k,x,E,S,L,C,$,P,_,B,I,T,A,D,V,N,R,j,q,M,W,U,F=e[5]?"▴":"▾",z=O(e[3]),H=[];for(let t=0;t<z.length;t+=1)H[t]=$e(Ee(e,z,t));return{c(){t=h("h1"),t.textContent="How to connect to doodlebot",n=v(),o=h("div"),i=h("h3"),i.textContent="1. Set network credentials:",s=v(),c=h("p"),d=f("SSID (Network Name):\n        "),w=h("input"),k=v(),x=h("p"),E=f("Password:\n        "),S=h("input"),L=v(),C=h("div"),$=h("button"),P=f(F),_=f(" Advanced"),B=v(),I=h("div"),T=h("p"),A=f("IP:\n            ");for(let e=0;e<H.length;e+=1)H[e].c();D=v(),V=h("div"),N=h("h3"),N.textContent="2. Select bluetooth device",R=v(),j=h("button"),q=f("Open Bluetooth Menu"),m(w,"type","text"),m(w,"placeholder","e.g. my_wifi"),m(S,"type","password"),m(S,"placeholder","e.g. 12345"),m($,"class","collapser svelte-7iy7lk"),b(I,"overflow","hidden"),b(I,"max-height",e[5]?"fit-content":"0"),j.disabled=M=!e[2]||!e[1]},m(r,u){l(r,t,u),l(r,n,u),l(r,o,u),a(o,i),a(o,s),a(o,c),a(c,d),a(c,w),e[10](w),y(w,e[1]),a(o,k),a(o,x),a(x,E),a(x,S),e[12](S),y(S,e[2]),a(o,L),a(o,C),a(C,$),a($,P),a($,_),a(C,B),a(C,I),a(I,T),a(T,A);for(let e=0;e<H.length;e+=1)H[e]&&H[e].m(T,null);l(r,D,u),l(r,V,u),a(V,N),a(V,R),a(V,j),a(j,q),W||(U=[p(w,"input",e[11]),p(S,"input",e[13]),p($,"click",e[14]),p(j,"click",e[7])],W=!0)},p(e,t){if(2&t&&w.value!==e[1]&&y(w,e[1]),4&t&&S.value!==e[2]&&y(S,e[2]),32&t&&F!==(F=e[5]?"▴":"▾")&&g(P,F),24&t){let n;for(z=O(e[3]),n=0;n<z.length;n+=1){const o=Ee(e,z,n);H[n]?H[n].p(o,t):(H[n]=$e(o),H[n].c(),H[n].m(T,null))}for(;n<H.length;n+=1)H[n].d(1);H.length=z.length}32&t&&b(I,"max-height",e[5]?"fit-content":"0"),6&t&&M!==(M=!e[2]||!e[1])&&(j.disabled=M)},d(i){i&&(u(t),u(n),u(o),u(D),u(V)),e[10](null),e[12](null),function(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}(H,i),W=!1,r(U)}}}function $e(e){let t,n,o,i,r,s=e[29]<e[3].length-1?".":"";function c(){e[16].call(t,e[29])}return{c(){t=h("input"),n=v(),o=f(s),m(t,"class","ip svelte-7iy7lk"),m(t,"type","text"),m(t,"placeholder","e.g. 192")},m(s,a){l(s,t,a),e[15](t),y(t,e[3][e[29]]),l(s,n,a),l(s,o,a),i||(r=p(t,"input",c),i=!0)},p(n,i){e=n,8&i&&t.value!==e[3][e[29]]&&y(t,e[3][e[29]]),8&i&&s!==(s=e[29]<e[3].length-1?".":"")&&g(o,s)},d(s){s&&(u(t),u(n),u(o)),e[15](null),i=!1,r()}}}function Pe(e){let o,i,r=e[0]&&Se(e);let s=function(e,t){return e[6]?Ce:Le}(e),c=s(e);return{c(){o=h("div"),r&&r.c(),i=v(),c.c(),m(o,"class","container svelte-7iy7lk"),b(o,"width","100%"),b(o,"background-color",t.color.ui.white),b(o,"color",t.color.text.primary)},m(e,t){l(e,o,t),r&&r.m(o,null),a(o,i),c.m(o,null)},p(e,[t]){e[0]?r?r.p(e,t):(r=Se(e),r.c(),r.m(o,i)):r&&(r.d(1),r=null),c.p(e,t)},i:n,o:n,d(e){e&&u(o),r&&r.d(),c.d()}}}function _e(e,n,o){var i,r,s,c,a,d,l=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};let{extension:u}=n,{close:h}=n;const{bluetooth:f}=window.navigator,v=(e,...n)=>t.reactiveInvoke(o(8,u),e,n),p="doodlebot-ssid",m="doodlebot-password",g="doodlebot-ip";let y,b=null!==(i=localStorage.getItem(p))&&void 0!==i?i:"",w=null!==(r=localStorage.getItem(m))&&void 0!==r?r:"";const k=localStorage.getItem(g),x=[null!==(s=null==k?void 0:k.split(".")[0])&&void 0!==s?s:"192",null!==(c=null==k?void 0:k.split(".")[1])&&void 0!==c?c:"168",null!==(a=null==k?void 0:k.split(".")[2])&&void 0!==a?a:"0",null!==(d=null==k?void 0:k.split(".")[3])&&void 0!==d?d:"0"],E={ssid:null,password:null};let L=!0;return e.$$set=e=>{"extension"in e&&o(8,u=e.extension),"close"in e&&o(9,h=e.close)},[y,b,w,x,E,L,f,()=>l(void 0,void 0,void 0,(function*(){const e=4===x.filter(Boolean).length?x.join("."):void 0;try{const t=yield ke.tryCreate(f,{credentials:{ssid:b,password:w,ipOverride:e},requestBluetooth:u.requestBluetooth.bind(u),saveIP:e=>localStorage.setItem(g,e)});v("setDoodlebot",t),localStorage.setItem(p,b),localStorage.setItem(m,w),e&&localStorage.setItem(g,e),h()}catch(e){v("setIndicator","disconnected"),console.error(e),o(0,y="Bluetooth adapter not available."===e.message?"Your device does not support BLE connections.":"User cancelled the requestDevice() chooser."==e.message?"You must select a device to connect to. Please try again.":"User cancelled the requestDevice() chooser."!==e.message?"There was a problem connecting your device, please try again or request assistance.":e.message)}})),u,h,function(e){S[e?"unshift":"push"]((()=>{E.ssid=e,o(4,E)}))},function(){b=this.value,o(1,b)},function(e){S[e?"unshift":"push"]((()=>{E.password=e,o(4,E)}))},function(){w=this.value,o(2,w)},()=>o(5,L=!L),function(e){S[e?"unshift":"push"]((()=>{E.password=e,o(4,E)}))},function(e){x[e]=this.value,o(3,x)}]}const Be={name:"Doodlebot",description:"Program a doodlebot robot",iconURL:"Replace with the name of your icon image file (which should be placed in the same directory as this file)",insetIconURL:"Replace with the name of your inset icon image file (which should be placed in the same directory as this file)",tags:["Made by PRG"]},Ie=["front","back","front or back","front and back","neither"];let Te=(()=>{var e;let n,o,i,r,s,c,a,d,l,u,h,f,v,p,m,g=t.extension(Be,"ui","indicators","video","drawable"),y=[];return e=class extends g{constructor(){super(...arguments),this.doodlebot=void function(e,t,n){for(var o=arguments.length>2,i=0;i<t.length;i++)n=o?t[i].call(e,n):t[i].call(e)}(this,y),this.bluetoothEmitter=new H}init(e){this.openUI("Connect"),this.setIndicator("disconnected")}setDoodlebot(e){this.doodlebot=e,this.setIndicator("connected")}setIndicator(e){var t;return F(this,void 0,void 0,(function*(){this.indicator&&(null===(t=yield this.indicator)||void 0===t||t.close()),this.indicator="connected"==e?this.indicate({position:"category",msg:"Connected to robot",type:"success",retry:!0}):this.indicate({position:"category",msg:"Not connected to robot",type:"warning",retry:!0})}))}requestBluetooth(e){this.bluetoothEmitter.once("bluetooth",e),this.openUI("ReattachBLE")}connect(){this.openUI("Connect")}drive(e,t){var n;return F(this,void 0,void 0,(function*(){const o="left"==e||"backward"==e?-t:t,i="right"==e||"backward"==e?-t:t;yield null===(n=this.doodlebot)||void 0===n?void 0:n.motorCommand("steps",{steps:o,stepsPerSecond:2e3},{steps:i,stepsPerSecond:2e3})}))}arc(e,t,n){var o;return F(this,void 0,void 0,(function*(){"right"==e&&(n*=-1),yield null===(o=this.doodlebot)||void 0===o?void 0:o.motorCommand("arc",t,n)}))}stop(){var e;return F(this,void 0,void 0,(function*(){yield null===(e=this.doodlebot)||void 0===e?void 0:e.motorCommand("stop")}))}movePen(e){var t;return F(this,void 0,void 0,(function*(){yield null===(t=this.doodlebot)||void 0===t?void 0:t.penCommand(e)}))}isBumperPressed(e){var t;return F(this,void 0,void 0,(function*(){const n=yield null===(t=this.doodlebot)||void 0===t?void 0:t.getSensorReading("bumper");switch(e){case"back":return n.back>0;case"front":return n.front>0;case"front or back":return n.front>0||n.back>0;case"front and back":return n.front>0&&n.back>0;case"neither":return 0===n.front&&0===n.back}}))}whenBumperPressed(e,t){var n;const o=null===(n=this.doodlebot)||void 0===n?void 0:n.getSensorReadingImmediately("bumper"),i="pressed"===t;switch(e){case"back":return i?o.back>0:0===o.back;case"front":return i?o.front>0:0===o.front;case"front or back":return i?o.front>0||o.back>0:0===o.front&&0===o.back;case"front and back":return i?o.front>0&&o.back>0:0===o.front||0===o.back;case"neither":return i?0===o.front&&0===o.back:o.front>0&&o.back>0}}getSingleSensorReading(e){var t;return F(this,void 0,void 0,(function*(){return yield null===(t=this.doodlebot)||void 0===t?void 0:t.getSensorReading(e)}))}disableSensor(e){var t;return F(this,void 0,void 0,(function*(){yield null===(t=this.doodlebot)||void 0===t?void 0:t.disableSensor(e)}))}clearDisplay(){var e;return F(this,void 0,void 0,(function*(){yield null===(e=this.doodlebot)||void 0===e?void 0:e.display("clear")}))}setDisplay(e){var t;return F(this,void 0,void 0,(function*(){yield null===(t=this.doodlebot)||void 0===t?void 0:t.display(e)}))}getIP(){var e;return F(this,void 0,void 0,(function*(){return null===(e=this.doodlebot)||void 0===e?void 0:e.getIPAddress()}))}connectToVideo(){var e;return F(this,void 0,void 0,(function*(){const t=yield null===(e=this.doodlebot)||void 0===e?void 0:e.getImageStream(),n=this.createDrawable(t);n.setVisible(!0),setInterval((()=>n.update(t)),100)}))}connectToAudio(){var e,t;return F(this,void 0,void 0,(function*(){const n=yield null===(e=this.doodlebot)||void 0===e?void 0:e.getIPAddress(),o=yield null===(t=this.doodlebot)||void 0===t?void 0:t.getAudioStream(n,10);yield new Promise((e=>setTimeout(e,9e3))),o.close()}))}sendMessage(e,t,n){var o,i;return F(this,void 0,void 0,(function*(){const r=Object.values(ne).filter((t=>t===e));if(0===r.length)return console.error(`Command ${ne} not found`);"BLE"===n?yield null===(o=this.doodlebot)||void 0===o?void 0:o.sendBLECommand(r[0],...ve(t)):yield null===(i=this.doodlebot)||void 0===i?void 0:i.sendWebsocketCommand(r[0],...ve(t))}))}},(()=>{var b;const w="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(b=g[Symbol.metadata])&&void 0!==b?b:null):void 0;n=[t.buttonBlock("Connect Robot")],o=[t.block({type:"command",text:(e,t)=>`drive ${e} for ${t} steps`,args:[{type:"string",options:["forward","backward","left","right"],defaultValue:"forward"},{type:"number",defaultValue:2e3}]})],i=[t.block({type:"command",text:(e,t,n)=>`arc ${e} with radius ${t} for ${n} degrees`,args:[{type:"string",options:["left","right"],defaultValue:"left"},{type:"number",defaultValue:2},{type:"number",defaultValue:90}]})],r=[t.block({type:"command",text:"Stop"})],s=[t.block({type:"command",text:e=>`move pen ${e}`,arg:{type:"string",options:["up","down"],defaultValue:"up"}})],c=[t.block({type:"Boolean",text:e=>`is ${e} bumper pressed`,arg:{type:"string",options:Ie,defaultValue:Ie[0]}})],a=[t.block({type:"hat",text:(e,t)=>`when ${e} bumper ${t}`,args:[{type:"string",options:Ie,defaultValue:Ie[0]},{type:"string",options:["release","pressed"],defaultValue:"pressed"}]})],d=[t.block({type:"reporter",text:e=>`${e} sensor`,arg:{type:"string",options:["battery","temperature","humidity","pressure","distance"],defaultValue:"battery"}})],l=[t.block({type:"command",text:e=>`disable ${e}`,arg:{type:"string",options:ie,defaultValue:ie[0]}})],u=[t.block({type:"command",text:"clear display"})],h=[t.block({type:"command",text:e=>`display ${e}`,arg:{type:"string",options:se.filter((e=>"clear"!==e)),defaultValue:"happy"}})],f=[t.block({type:"reporter",text:"get IP address"})],v=[t.block({type:"command",text:"connect video"})],p=[t.block({type:"command",text:"connect audio"})],m=[t.block({type:"command",text:(e,t,n)=>`send (${e}, ${t}) over ${n}`,args:[{type:"string",defaultValue:"u"},{type:"string",defaultValue:"0"},{type:"string",options:["BLE","Websocket"],defaultValue:"BLE"}]})],U(e,null,n,{kind:"method",name:"connect",static:!1,private:!1,access:{has:e=>"connect"in e,get:e=>e.connect},metadata:w},null,y),U(e,null,o,{kind:"method",name:"drive",static:!1,private:!1,access:{has:e=>"drive"in e,get:e=>e.drive},metadata:w},null,y),U(e,null,i,{kind:"method",name:"arc",static:!1,private:!1,access:{has:e=>"arc"in e,get:e=>e.arc},metadata:w},null,y),U(e,null,r,{kind:"method",name:"stop",static:!1,private:!1,access:{has:e=>"stop"in e,get:e=>e.stop},metadata:w},null,y),U(e,null,s,{kind:"method",name:"movePen",static:!1,private:!1,access:{has:e=>"movePen"in e,get:e=>e.movePen},metadata:w},null,y),U(e,null,c,{kind:"method",name:"isBumperPressed",static:!1,private:!1,access:{has:e=>"isBumperPressed"in e,get:e=>e.isBumperPressed},metadata:w},null,y),U(e,null,a,{kind:"method",name:"whenBumperPressed",static:!1,private:!1,access:{has:e=>"whenBumperPressed"in e,get:e=>e.whenBumperPressed},metadata:w},null,y),U(e,null,d,{kind:"method",name:"getSingleSensorReading",static:!1,private:!1,access:{has:e=>"getSingleSensorReading"in e,get:e=>e.getSingleSensorReading},metadata:w},null,y),U(e,null,l,{kind:"method",name:"disableSensor",static:!1,private:!1,access:{has:e=>"disableSensor"in e,get:e=>e.disableSensor},metadata:w},null,y),U(e,null,u,{kind:"method",name:"clearDisplay",static:!1,private:!1,access:{has:e=>"clearDisplay"in e,get:e=>e.clearDisplay},metadata:w},null,y),U(e,null,h,{kind:"method",name:"setDisplay",static:!1,private:!1,access:{has:e=>"setDisplay"in e,get:e=>e.setDisplay},metadata:w},null,y),U(e,null,f,{kind:"method",name:"getIP",static:!1,private:!1,access:{has:e=>"getIP"in e,get:e=>e.getIP},metadata:w},null,y),U(e,null,v,{kind:"method",name:"connectToVideo",static:!1,private:!1,access:{has:e=>"connectToVideo"in e,get:e=>e.connectToVideo},metadata:w},null,y),U(e,null,p,{kind:"method",name:"connectToAudio",static:!1,private:!1,access:{has:e=>"connectToAudio"in e,get:e=>e.connectToAudio},metadata:w},null,y),U(e,null,m,{kind:"method",name:"sendMessage",static:!1,private:!1,access:{has:e=>"sendMessage"in e,get:e=>e.sendMessage},metadata:w},null,y),w&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:w})})(),e})();return e.Connect=class extends j{constructor(e){super(),R(this,e,_e,Pe,c,{extension:8,close:9},xe)}},e.Extension=Te,e.ReattachBLE=class extends j{constructor(e){super(),R(this,e,W,M,c,{extension:2,close:3},q)}},Object.defineProperty(e,"__esModule",{value:!0}),e}({},ExtensionFramework);//# sourceMappingURL=doodlebot.js.map
