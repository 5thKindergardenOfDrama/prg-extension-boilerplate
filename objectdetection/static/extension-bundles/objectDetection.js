var objectDetection=function(e,t){"use strict";function i(e,t,i,o,s,n){function c(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,r=o.kind,l="getter"===r?"get":"setter"===r?"set":"value",d=!t&&e?o.static?e:e.prototype:null,h=t||(d?Object.getOwnPropertyDescriptor(d,o.name):{}),u=!1,p=i.length-1;p>=0;p--){var m={};for(var f in o)m[f]="access"===f?{}:o[f];for(var f in o.access)m.access[f]=o.access[f];m.addInitializer=function(e){if(u)throw new TypeError("Cannot add initializers after decoration has completed");n.push(c(e||null))};var g=(0,i[p])("accessor"===r?{get:h.get,set:h.set}:h[l],m);if("accessor"===r){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(a=c(g.get))&&(h.get=a),(a=c(g.set))&&(h.set=a),(a=c(g.init))&&s.push(a)}else(a=c(g))&&("field"===r?s.push(a):h[l]=a)}d&&Object.defineProperty(d,o.name,h),u=!0}function o(e,t,i,o){return new(i||(i=Promise))((function(s,n){function c(e){try{r(o.next(e))}catch(e){n(e)}}function a(e){try{r(o.throw(e))}catch(e){n(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(c,a)}r((o=o.apply(e,t||[])).next())}))}const s={name:"Object Detection",description:"Detects and identifies the object shown!",iconURL:"Typescript_logo.png",insetIconURL:"typescript-logo.svg"};var n=(()=>{var e;let n,c,a,r,l,d=[];return e=class extends(t.extension(s,"video","drawable","addCostumes","toggleVideoBlock","setTransparencyBlock")){constructor(){super(...arguments),this.detector=void function(e,t,i){for(var o=arguments.length>2,s=0;s<t.length;s++)i=o?t[s].call(e,i):t[s].call(e)}(this,d),this.continuous=!1,this.processFreq=100,this.drawables=[],this.color="white",this.thickness=5}init(){return o(this,void 0,void 0,(function*(){this.enableVideo(),this.detector=yield o(void 0,void 0,void 0,(function*(){const{ObjectDetector:e,FilesetResolver:t}=yield import("https://cdn.skypack.dev/@mediapipe/tasks-vision@0.1.0-alpha-11"),i=yield t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.1.0-alpha-11/wasm");return yield e.createFromOptions(i,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite"},scoreThreshold:.5,runningMode:"IMAGE"})})),this.imageHelper=((e,t)=>{const i=document.body.appendChild(document.createElement("canvas"));i.hidden=!0,i.width=e,i.height=t;const o=i.getContext("2d");return{createRects(i,s,n){o.save(),o.clearRect(0,0,e,t),o.fillStyle=s;for(let e of i){const{originX:t,originY:i,width:s,height:c}=e.boundingBox;o.fillRect(t,i,s,c),o.clearRect(t+n,i+n,s-2*n,c-2*n);const a=e.categories[0].categoryName+" - with "+Math.round(100*parseFloat(e.categories[0].score))+"% confidence.";o.fillText(a,t,i-5)}return o.restore(),o.getImageData(0,0,e,t)}}})(this.videoDimensions.width,this.videoDimensions.height)}))}detectionLoop(){return o(this,void 0,void 0,(function*(){for(;this.continuous;){const e=this.getVideoFrame("canvas"),i=Date.now();if(e){const t=yield this.detector.detect(e);this.displayImageDetections(t)}const o=Date.now()-i;yield t.untilTimePassed(this.processFreq-o),this.clearFrame()}}))}clearFrame(){for(;this.drawables.length>0;)this.drawables.shift().destroy()}displayImageDetections(e){return o(this,void 0,void 0,(function*(){const{drawables:t,imageHelper:i}=this,o=i.createRects(e.detections,this.color,this.thickness);t.push(this.createDrawable(o))}))}setFrameRate(e){this.processFreq=1e3/e}setColor(e){this.color=t.rgbToHex(e)}setThickness(e){this.thickness=isNaN(e)?5:Math.min(Math.max(0,e),50)}detectObject(e){return o(this,void 0,void 0,(function*(){const i=this.getVideoFrame("canvas"),o=yield this.detector.detect(i);this.displayImageDetections(o),yield t.untilTimePassed(1e3*e),this.clearFrame()}))}continuouslyDetectObjects(e){return o(this,void 0,void 0,(function*(){this.continuous=e,this.detectionLoop()}))}},n=[t.block({type:"command",text:e=>`Set detection rate to ${e}`,arg:{type:"number",options:[60,30,10,2,1],defaultValue:10}})],c=[t.block({type:"command",text:e=>`Set box color to ${e}`,arg:"color"})],a=[t.block({type:"command",text:e=>`Set box thickness to ${e}`,arg:{type:"number",defaultValue:5,handler:e=>isNaN(e)?5:Math.min(Math.max(0,e),50)}})],r=[t.block({type:t.BlockType.Command,text:e=>`Detect objects for ${e} seconds`,arg:{type:t.ArgumentType.Number,defaultValue:1}})],l=[t.block({type:t.BlockType.Command,text:e=>`Turn continuous detection ${e}`,arg:{type:t.ArgumentType.Boolean,options:[{text:"on",value:!0},{text:"off",value:!1}]}})],i(e,null,n,{kind:"method",name:"setFrameRate",static:!1,private:!1,access:{has:e=>"setFrameRate"in e,get:e=>e.setFrameRate}},null,d),i(e,null,c,{kind:"method",name:"setColor",static:!1,private:!1,access:{has:e=>"setColor"in e,get:e=>e.setColor}},null,d),i(e,null,a,{kind:"method",name:"setThickness",static:!1,private:!1,access:{has:e=>"setThickness"in e,get:e=>e.setThickness}},null,d),i(e,null,r,{kind:"method",name:"detectObject",static:!1,private:!1,access:{has:e=>"detectObject"in e,get:e=>e.detectObject}},null,d),i(e,null,l,{kind:"method",name:"continuouslyDetectObjects",static:!1,private:!1,access:{has:e=>"continuouslyDetectObjects"in e,get:e=>e.continuouslyDetectObjects}},null,d),e})();return e.Extension=n,Object.defineProperty(e,"__esModule",{value:!0}),e}({},ExtensionFramework);//# sourceMappingURL=objectDetection.js.map
