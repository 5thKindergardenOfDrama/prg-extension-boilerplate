var objectDetection=function(e,t){"use strict";function o(e,t,o,i,s,n){function c(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,r=i.kind,l="getter"===r?"get":"setter"===r?"set":"value",d=!t&&e?i.static?e:e.prototype:null,h=t||(d?Object.getOwnPropertyDescriptor(d,i.name):{}),u=!1,p=o.length-1;p>=0;p--){var m={};for(var f in i)m[f]="access"===f?{}:i[f];for(var f in i.access)m.access[f]=i.access[f];m.addInitializer=function(e){if(u)throw new TypeError("Cannot add initializers after decoration has completed");n.push(c(e||null))};var g=(0,o[p])("accessor"===r?{get:h.get,set:h.set}:h[l],m);if("accessor"===r){if(void 0===g)continue;if(null===g||"object"!=typeof g)throw new TypeError("Object expected");(a=c(g.get))&&(h.get=a),(a=c(g.set))&&(h.set=a),(a=c(g.init))&&s.push(a)}else(a=c(g))&&("field"===r?s.push(a):h[l]=a)}d&&Object.defineProperty(d,i.name,h),u=!0}function i(e,t,o,i){return new(o||(o=Promise))((function(s,n){function c(e){try{r(i.next(e))}catch(e){n(e)}}function a(e){try{r(i.throw(e))}catch(e){n(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(c,a)}r((i=i.apply(e,t||[])).next())}))}const s={name:"Object Detection",description:"Detects and identifies the object shown!",iconURL:"Typescript_logo.png",insetIconURL:"typescript-logo.svg"};var n=(()=>{var e;let n,c,a,r,l,d=[];return e=class extends(t.extension(s,"video","drawable","addCostumes","toggleVideoBlock","setTransparencyBlock")){constructor(){super(...arguments),this.detector=void function(e,t,o){for(var i=arguments.length>2,s=0;s<t.length;s++)o=i?t[s].call(e,o):t[s].call(e)}(this,d),this.continuous=!1,this.DIMENSIONS=[480,360],this.processFreq=100,this.drawables=[],this.color="white",this.thickness=5}init(){return i(this,void 0,void 0,(function*(){this.enableVideo(),this.detector=yield i(void 0,void 0,void 0,(function*(){const{ObjectDetector:e,FilesetResolver:t}=yield import("https://cdn.skypack.dev/@mediapipe/tasks-vision@0.1.0-alpha-11"),o=yield t.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.1.0-alpha-11/wasm");return yield e.createFromOptions(o,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite"},scoreThreshold:.5,runningMode:"IMAGE"})})),this.imageHelper=((e,t)=>{const o=document.body.appendChild(document.createElement("canvas"));o.hidden=!0,o.width=e,o.height=t;const i=o.getContext("2d");return{createRects(o,s,n){i.save(),i.clearRect(0,0,e,t),i.fillStyle=s;for(let e of o){const{originX:t,originY:o,width:s,height:c}=e.boundingBox;i.fillRect(t,o,s,c),i.clearRect(t+n,o+n,s-2*n,c-2*n);const a=e.categories[0].categoryName+" - with "+Math.round(100*parseFloat(e.categories[0].score))+"% confidence.";i.fillText(a,t,o-5)}return i.restore(),i.getImageData(0,0,e,t)}}})(this.DIMENSIONS[0],this.DIMENSIONS[1])}))}detectionLoop(){return i(this,void 0,void 0,(function*(){for(;this.continuous;){const e=this.getVideoFrame("canvas"),o=Date.now();if(e){const t=yield this.detector.detect(e);this.displayImageDetections(t)}const i=Date.now()-o;yield t.untilTimePassed(this.processFreq-i),this.clearFrame()}}))}clearFrame(){for(;this.drawables.length>0;)this.drawables.shift().destroy()}displayImageDetections(e){return i(this,void 0,void 0,(function*(){const{drawables:t,imageHelper:o}=this,i=o.createRects(e.detections,this.color,this.thickness);t.push(this.createDrawable(i))}))}setFrameRate(e){this.processFreq=1e3/e}setColor(e){this.color=t.rgbToHex(e)}setThickness(e){this.thickness=e}detectObject(e){return i(this,void 0,void 0,(function*(){const o=this.getVideoFrame("canvas"),i=yield this.detector.detect(o);this.displayImageDetections(i),yield t.untilTimePassed(1e3*e),this.clearFrame()}))}continuouslyDetectObjects(e){return i(this,void 0,void 0,(function*(){this.continuous=e,this.detectionLoop()}))}},n=[t.block({type:"command",text:e=>`Set detection rate to ${e}`,arg:{type:"number",options:[60,30,10,2,1],defaultValue:10}})],c=[t.block({type:"command",text:e=>`Set box color to ${e}`,arg:"color"})],a=[t.block({type:"command",text:e=>`Set box thickness to ${e}`,arg:{type:"number",defaultValue:5,handler:e=>Math.min(Math.max(0,e),20)}})],r=[t.block({type:t.BlockType.Command,text:e=>`Detect objects for ${e} seconds`,arg:{type:t.ArgumentType.Number,defaultValue:1}})],l=[t.block({type:t.BlockType.Command,text:e=>`Turn continuous detection ${e}`,arg:{type:t.ArgumentType.Boolean,options:[{text:"on",value:!0},{text:"off",value:!1}]}})],o(e,null,n,{kind:"method",name:"setFrameRate",static:!1,private:!1,access:{has:e=>"setFrameRate"in e,get:e=>e.setFrameRate}},null,d),o(e,null,c,{kind:"method",name:"setColor",static:!1,private:!1,access:{has:e=>"setColor"in e,get:e=>e.setColor}},null,d),o(e,null,a,{kind:"method",name:"setThickness",static:!1,private:!1,access:{has:e=>"setThickness"in e,get:e=>e.setThickness}},null,d),o(e,null,r,{kind:"method",name:"detectObject",static:!1,private:!1,access:{has:e=>"detectObject"in e,get:e=>e.detectObject}},null,d),o(e,null,l,{kind:"method",name:"continuouslyDetectObjects",static:!1,private:!1,access:{has:e=>"continuouslyDetectObjects"in e,get:e=>e.continuouslyDetectObjects}},null,d),e})();return e.Extension=n,Object.defineProperty(e,"__esModule",{value:!0}),e}({},ExtensionFramework);//# sourceMappingURL=objectDetection.js.map
